## План изменения логики бронирования слотов (тип слота задаётся первым бронированием)

Документ описывает минимальный, точный и безопасный план изменения логики слотов в проекте **pilatesreformer18**, на основе последнего уточнения:  
**Тип тренировки привязывается к конкретному слоту (тренер + дата + время) только в момент первого бронирования.**

---

# Общий прогресс: 0%

---

# 1. Поведение слота (новая логика)

## 1.1. Базовые принципы (для разработчика)
- ⬜️ Слот = уникальная комбинация **тренер + дата + время**.
- ⬜️ До первого бронирования слот **не имеет типа**, `Типтренировки` в Schedule пустой.
- ⬜️ Первый клиент, бронирующий этот слот, **задаёт тип слота** (lesson_type).
- ⬜️ Все последующие брони в этот же слот **должны совпадать** по типу со слотом.
- ⬜️ Если тип не совпадает — слот **не показывать** клиенту.

---

# 2. Изменения в Google Sheets (Schedule / Bookings)

## 2.1. Schedule
- ⬜️ Убедиться, что в Schedule есть колонка `Типтренировки`.
- ⬜️ Изначально для всех слотов она пустая.

## 2.2. Bookings
- ⬜️ Каждая запись должна сохранять `Типтренировки` = lesson_type клиента.
- ⬜️ При первом бронировании слота — **копировать тип** в Schedule.

---

# 3. Изменения в логике выбора слота в боте

## 3.1. Выбор типа → тренера → даты → времени
- ⬜️ Пользователь первым шагом выбирает **lesson_type**.
- ⬜️ Далее выбирает тренера, затем дату.

## 3.2. Формирование списка доступных времён
- ⬜️ Для каждого слота получаем:
  - `Свободно`
  - `Типтренировки` (может быть пустым)
- ⬜️ Слот показывается клиенту, **если**:
  - `Свободно > 0`,    
  - `Типтренировки` пустой **ИЛИ** `Типтренировки == выбранному lesson_type`.

## 3.3. Первый клиент задаёт тип
- ⬜️ Если `Типтренировки` пустой → после бронирования:
  - записать lesson_type в Schedule,
  - записать lesson_type в Bookings.

## 3.4. Последующие клиенты
- ⬜️ Если слот уже имеет тип:
  - показывать его **только если тип совпадает** с выбранным lesson_type.

---

# 4. Изменения в логике отмены

## 4.1. Корректная отмена (>= 10 часов)
- ⬜️ `Свободно += 1`.
- ⬜️ **Тип слота не менять** (слот остаётся привязанным к типу, заданному первым клиентом).

## 4.2. Поздняя отмена (< 10 часов)
- ⬜️ У абонемента — списывается занятие.
- ⬜️ Слот логически остаётся того же типа.
- ⬜️ Поведение по `Свободно` — базовый вариант:
  - ⬜️ `Свободно += 1`,  
    *(в план вносится как базовая логика, можно будет уточнить при реализации)*

---

# 5. Изменения в модулях проекта

## 5.1. `google_sheets.py`
- ⬜️ Добавить чтение `Типтренировки` из Schedule.
- ⬜️ Добавить функцию `update_slot_type(row_index, lesson_type)`.
- ⬜️ Обновить функцию получения слотов:  
  - ⬜️ учитывать пустой тип,  
  - ⬜️ учитывать совпадение типа.
- ⬜️ При создании брони:  
  - ⬜️ если `Типтренировки` пустой → записать туда lesson_type.

## 5.2. `booking.py`
- ⬜️ Сохранить выбранный клиентом lesson_type в FSM.
- ⬜️ Перед выводом времени фильтровать слоты по правилам (п.3.2).
- ⬜️ При создании брони:
  - ⬜️ записывать lesson_type в Booking,
  - ⬜️ писать lesson_type в Bookings,
  - ⬜️ при необходимости вызывать `update_slot_type`.

## 5.3. `models.py`
- ⬜️ Поле `lesson_type` в модели Booking — обязательно.
- ⬜️ Не менять модель абонемента.

---

# 6. Визуальное отображение в боте

## 6.1. Слоты времени
- ⬜️ При выводе времени слота показывать остаток:  
  `"10:00 (осталось 2 из 3)"`

## 6.2. Ошибка несовместимости
- ⬜️ Если пользователь выбрал тип, но ни один слот с таким типом недоступен → текст:  
  “На выбранную дату нет подходящих слотов для этого типа занятия. Выберите другую дату или другой тип.”

---

# 7. Тест-план после внедрения

## 7.1. Кейс 1 — первый пользователь задаёт тип
- ⬜️ Выбрать пустой слот  
- ⬜️ Выбрать тип (например, индивидуальный)  
- ⬜️ Забронировать  
- ⬜️ Проверить в Schedule → тип появился  
- ⬜️ Бронь отображается в Bookings с этим типом

## 7.2. Кейс 2 — несовпадение типа
- ⬜️ Второй пользователь выбирает другой type → слот не должен показываться

## 7.3. Кейс 3 — отмена
- ⬜️ Отмена >= 10 часов → тип остаётся  
- ⬜️ Отмена < 10 часов → занятие списывается, тип остаётся
